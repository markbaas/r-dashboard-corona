---
title: "Data pipeline"
output: html_notebook
---

### Imports
```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(lubridate)
library(cbsodataR)
library(httr)
library(aweek)

```

### Get Mortality Rate data from CBS

```{r}

cbs_week_dates <- function(x) {
  m <- str_match(x, "(\\d{4})[^J][0,1](\\d+)")
  year <- m[1,2] %>% as.numeric()
  week <- m[1,3] %>% as.numeric()

  if (is.na(year)) {
    return(as.Date(NA))
  } else if (week == 0) {
    to <- aweek::get_date(year = year, week = 1) - 1
    from <- date(ISOdate(year, 1, 1))
  } else if (week == 1) {
    to <- aweek::get_date(year = year, week = 2) - 1
    from <- max(date(ISOdate(year, 1, 1)), aweek::get_date(year = year, week = 1))
  } else {
    from <- aweek::get_date(year = year, week = week)
    to <- min(date(ISOdate(year, 12, 31)), from + 6)
  }

  return(
    if (from > to) from 
    else seq(from, to, by = "1 day")
  )
}

mort <- cbs_get_data("70895NED") %>%
  filter(
    Geslacht == "1100" &
    LeeftijdOp31December == "10000"
  ) %>%
  mutate(
    Deaths = Overledenen_1,
    Date = Perioden %>% map(cbs_week_dates),
    Period = Perioden
  ) %>% drop_na() %>% 
  unnest(Date) %>%
  drop_na(Date) %>%
  select("Date", "Period", "Deaths") %>%
  arrange(desc(Date))
  
mort 

# cbs_week_dates("2019W153")
```

### Get population data from CBS

```{r}
pop <- 
  cbs_get_data("83474NED") %>%
  filter(str_detect(Perioden, "\\d{4}MM\\d{2}")) %>%
  mutate(
    Date = date(parse_date_time(Perioden, "y m")),
    Year = year(Date),
    Month = month(Date),
    Population = BevolkingAanHetBeginVanDePeriode_1 
  ) %>%
  select("Date", "Population")

pop
```

### Get Maximum Temperature data from KNMI

```{r}
r <- POST(
  "http://projects.knmi.nl/klimatologie/daggegevens/getdata_dag.cgi",
  body = list(
    start = "19950101",
    end = strftime(today(), format = "%Y%m%d"),
    vars = "TX",
    stns = "ALL"
  )
)

temp <- content(r, as = "raw") %>%
  read_delim(
    ",",
    comment = "#",
    col_names = c("Station", "Date", "Temperature"),
    col_types = "ici",
    trim_ws = TRUE
  ) %>%
  drop_na() %>%
  mutate(Date = ymd(Date))
  # group_by(Date) %>%
  # summarise(
  #   Temperature = mean(Temperature)
  # )

head(temp)
```

### Get air quality data

Fill in missing days.

```{r}
air <- read_rds("../results/luchtmeetnet.Rds") %>%
  # group_by(Date, Variable) %>%
  # summarise(
  #   Value = mean(Value)
  # ) %>%
  # ungroup() %>%
  spread(Variable, Value) %>%
  select("Date", "PM2.5", "PM10", "NO2", "O3") %>%
  arrange(Date)

head(air)
```

Aggregate by week

```{r}
# air <- air.daily %>%
#   group_by(Date, Variable) %>%
#   drop_na() %>%
#   summarise(
#     Value = mean(Value)
#   ) %>%
#   ungroup() %>%
#   spread(Variable, Value) %>%
#   select("Year", "Week", "PM2.5", "PM10", "NO2") %>%
#   arrange(desc(Year), desc(Week))
# 
# air
```

### Join all into one dataframe

All tables are being joined cbs periods 
Empty population data is filled from the previous months.

```{r}
data.joined <- mort %>%
  left_join(pop, by = c("Date")) %>%
  left_join(temp, by = c("Date")) %>%
  left_join(air, by = c("Date")) %>%
  group_by(Period) %>%
  summarise(
    Days = (max(Date) - min(Date) + 1) %>% as.numeric(units = "days"),
    StartPeriod = min(Date),
    Date = max(Date),
    Deaths = max(Deaths),
    Population = last(na.omit(Population), default = NA),
    Temperature = mean(Temperature, na.rm = T),
    PM2.5 = mean(PM2.5, na.rm = T),
    PM10 = mean(PM10, na.rm = T),
    NO2 = mean(NO2, na.rm = T),
    O3 = mean(O3, na.rm = T)
  ) %>%
  arrange(desc(Date)) %>%
  fill(Population, .direction = "downup")

data.joined
```

### Calculate the mortality rate

We will calculate the mortality rate the deaths by 1,000,000 inhabitants.
Additionally, we'll add columns for mortality rates in the previous 8 weeks.


```{r}

data <- data.joined %>%
  mutate(MortalityRate = Deaths * 100000 / Population / Days * 7, # to normalise week 53 and 1 
         Regio = "NL",
         Interval = "week",
         Period = str_match(Period, "\\y{4}[^J]\\d(\\d{2})"),
         "MortalityRate.-1" = lag(MortalityRate, 1, order_by = Date),
         "MortalityRate.-2" = lag(MortalityRate, 2, order_by = Date),
         "MortalityRate.-3" = lag(MortalityRate, 3, order_by = Date),
         "MortalityRate.-4" = lag(MortalityRate, 4, order_by = Date),
         "MortalityRate.-5" = lag(MortalityRate, 5, order_by = Date),
         "MortalityRate.-6" = lag(MortalityRate, 6, order_by = Date),
         "MortalityRate.-7" = lag(MortalityRate, 7, order_by = Date),
         "MortalityRate.-8" = lag(MortalityRate, 8, order_by = Date),
         "MortalityRate.-9" = lag(MortalityRate, 5, order_by = Date),
         "MortalityRate.-10" = lag(MortalityRate, 6, order_by = Date),
         "MortalityRate.-11" = lag(MortalityRate, 7, order_by = Date),
         "MortalityRate.-12" = lag(MortalityRate, 8, order_by = Date),
        ) %>%
  select(-Days, -StartPeriod, Period)
data
```

### Save data

```{r}
write_rds(data, "../results/data.Rds")

isoweek(ISOdate(2005,1,1))
ISOweek::date2ISOweek(ISOdate(2005,1,1))
```
