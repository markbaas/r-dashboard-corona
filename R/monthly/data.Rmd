---
title: "Data pipeline"
output: html_document
---

### Imports
```{r message=FALSE, warning=FALSE}
library(raster)
library(tidyverse)
library(lubridate)
library(cbsodataR)
library(httr)
library(aweek)
library(glue)
library(tmaptools)
library(sf)
library(sp)
library(tmap)
library(leaflet)
library(dplyr)
source("../knmi.R")
```

### Get gemeente boundaries

```{r}
areas <- GET("https://opendata.arcgis.com/datasets/e1f0dd70abcb4fceabbc43412e43ad4b_0.geojson") %>% content(as = "text") %>%
  read_sf() %>%
  rename(RegioS = Gemeentecode) %>%
  select("RegioS")

tm_shape(areas) +
  tm_borders()
```


### Get Mortality and Population data from CBS

```{r}
pop.cbs <- cbs_get_data("37230NED") %>%
  filter(
    str_detect(Perioden, "\\d{4}MM\\d{2}") & 
    str_detect(RegioS, "GM\\d+")
  )

pop <- pop.cbs %>%
  filter(str_detect(RegioS, "GM\\d+")) %>%
  mutate(
    Year = Perioden %>% str_extract("\\d{4}") %>% as.numeric(),
    Month = Perioden %>% str_match("\\d{4}MM(\\d{2})") %>% .[,2] %>% as.numeric(),
    Date = ISOdate(Year, Month, 1) + duration(1, unit="month") - 1,
    Deaths = Overledenen_3,
    Population = BevolkingAanHetEindeVanDePeriode_15
  ) %>%
  select("Year", "Month", "RegioS", "Population", "Deaths") %>%
  drop_na(Population) %>%
  arrange(desc(Year), desc(Month))
  
head(pop)
```

### Join all into one dataframe

All tables are being join on year and month/week. 
Empty population data is filled from the previous months.

```{r}
calendar <- data.frame(Date = seq(as.Date("2014-01-01"), as.Date("2020-12-31"), by = "day")) %>%
  mutate(
    Year = year(Date),
    Month = month(Date)
  ) %>%
  group_by(Year, Month) %>%
  summarise(Date = last(Date)) %>%
  ungroup() %>%
  select(Year, Month) %>%
  crossing(areas %>% select("RegioS") %>% st_set_geometry(NULL) %>% distinct())

data <- calendar %>%
  left_join(pop, by = c("Year", "Month", "RegioS")) %>%
  left_join(read_rds("../results/spatial/temp.Rds"), by = c("Year", "Month", "RegioS")) %>%
  left_join(read_rds("../results/spatial/air.Rds"), by = c("Year", "Month", "RegioS")) %>%
  group_by(RegioS) %>%
  fill(Population, .direction = "down")  %>%
  ungroup() %>%
  arrange(desc(Year), desc(Month))

head(data, 5)
```

### Calculate the mortality rate

We will calculate the mortality rate the deaths by 1,000,000 inhabitants.
Additionally, we'll add columns for mortality rates in the previous 8 weeks.


```{r}

data <- data %>%
  mutate(MortalityRate = Deaths * 1000000 / Population,
         "MortalityRate.-1" = lag(MortalityRate, 1, order_by = Date),
         "MortalityRate.-2" = lag(MortalityRate, 2, order_by = Date),
         "MortalityRate.-3" = lag(MortalityRate, 3, order_by = Date),
        )
head(data, 5)
```

### Save data

```{r}
write_rds(data, "../../results/spatial/history.RDS")
```
